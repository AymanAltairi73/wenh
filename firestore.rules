rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isWorker() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/workers/$(request.auth.uid));
    }

    function isCustomer() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Users (Customers) Collection ---
    match /users/{userId} {
      // Admin Map requires list + get
      allow list, get: if isAdmin();
      // Users can manage their own data
      allow read, write: if isOwner(userId);
      // Workers can see specific customer details for their accepted requests
      allow get: if isWorker();
    }

    // --- Workers Collection ---
    match /workers/{workerId} {
      // Admin list/get
      allow list, get: if isAdmin();
      // Customers see all workers on the map
      allow list, get: if isAuthenticated();
      // Worker updates their OWN location
      allow update: if isOwner(workerId) && 
        request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['latitude', 'longitude', 'lastLocationUpdate', 'updatedAt', 'lastLogin']);
      // Allow full write for admin or owner (for profile setup)
      allow write: if isAdmin() || isOwner(workerId);
    }

    // --- Requests Collection ---
    match /requests/{requestId} {
      // Admin sees/manages all
      allow read, write: if isAdmin();
      // Workers see new requests
      allow list: if isWorker();
      allow get: if isWorker() || isOwner(resource.data.createdBy);
      // Customers create requests
      allow create: if isAuthenticated();
      // Workers take/complete requests
      allow update: if isWorker();
    }

    // --- Admins Collection ---
    match /admins/{adminId} {
      allow read, write: if isOwner(adminId) || isAdmin();
      allow list: if isAuthenticated();
    }
    
    // --- Stats / Metadata ---
    match /stats/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
